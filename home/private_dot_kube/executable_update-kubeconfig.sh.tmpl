#!/usr/bin/env bash
# -*- coding: utf-8 -*-
mkdir -p ~/.kube/backup
DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
echo $DATE
mv config backup/config-$DATE

{{- if .isWorkComputer }}

KUBELOGIN_CONFIGS="<kubeconfigs-here>"
REGULAR_CONFIGS="<kubeconfigs-here>"
INTERACTIVE_CONFIGS="<kubeconfigs-here>"

for config in ${KUBELOGIN_CONFIGS//:/ }; do
    if [ -f "$config" ]; then
        echo "Converting $config with kubelogin..."
        KUBECONFIG=$config kubelogin convert-kubeconfig -l azurecli
    fi
done

TEMP_CONFIGS=""
for config in ${INTERACTIVE_CONFIGS//:/ }; do
    if [ -f "$config" ]; then
        echo "Making user names unique in $config..."
        TEMP_FILE="${config}.tmp"
        # Replace both the user name definition AND the context reference
        sed "s/name: azure-user/name: azure-user-${config}/g; s/user: azure-user/user: azure-user-${config}/g" "$config" > "$TEMP_FILE"
        TEMP_CONFIGS="${TEMP_CONFIGS}:${TEMP_FILE}"
    fi
done

ALL_CONFIGS="${KUBELOGIN_CONFIGS}:${REGULAR_CONFIGS}"
KUBECONFIG=$ALL_CONFIGS kubectl config view --merge --flatten >config

# Cleanups
for config in ${AZURE_USER_CONFIGS//:/ }; do
    rm -f "${config}.tmp"
done

{{- else }}

ALL_CONFIGS="<kubeconfigs-here>"
KUBECONFIG=$ALL_CONFIGS kubectl config view --merge --flatten >config

{{- end }}
